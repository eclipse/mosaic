/*
 * Copyright (c) 2020 Fraunhofer FOKUS and others. All rights reserved.
 *
 * See the NOTICE file(s) distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program and the accompanying materials are made available under the
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0
 *
 * SPDX-License-Identifier: EPL-2.0
 */

package org.eclipse.mosaic.lib.routing.util;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

import org.eclipse.mosaic.lib.database.Database;

import com.google.common.collect.Lists;
import org.apache.commons.io.FileUtils;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TemporaryFolder;

import java.io.File;
import java.io.IOException;
import java.util.List;

public class RouteFixerTest {

    private final List<String> brokenRoute = Lists.newArrayList(
            "52955705_30994888_670715050_331876963", "52955705_30994888_670715050_5044761090", "52924187_30994903_670046017_670714514",
            "52924187_30994903_670046017_670714503", "52924187_30994903_670046017_331877150", "52924187_30994903_670046017_670046050", "52924187_30994903_670046017_5044847223",
            "52924187_30994903_670046017_670046010", "52835767_670046017_334389638_670046017", "52835767_670046017_334389638_670046019", "52835767_670046017_334389638_670046014",
            "52835767_670046017_334389638_670046015", "52835767_670046017_334389638_670045998", "52835767_670046017_334389638_334389626", "52835767_670046017_334389638_670045999",
            "52835767_670046017_334389638_334389627", "52835767_670046017_334389638_670045997", "52835767_670046017_334389638_670045996", "52835767_670046017_334389638_334389628",
            "52835767_670046017_334389638_670045992", "52835767_670046017_334389638_334389629", "52835767_670046017_334389638_670045993", "52835767_670046017_334389638_334389630",
            "52835767_670046017_334389638_670045994", "52835767_670046017_334389638_334389631", "52835767_670046017_334389638_670045985", "52835767_670046017_334389638_334389632",
            "52835767_670046017_334389638_670045986", "52835767_670046017_334389638_334389633", "52835767_670046017_334389638_670045987", "52835767_670046017_334389638_334389634",
            "52835767_670046017_334389638_670045989", "52835767_670046017_334389638_334389635", "52835767_670046017_334389638_670045991", "52835767_670046017_334389638_334389636",
            "52835767_670046017_334389638_670046000", "52835767_670046017_334389638_334389637", "52835767_670046017_334389638_670046002", "48403983_334389638_334389639_334389638",
            "48403988_334389639_334389642_334389639", "48403988_334389639_334389642_334389640", "48403988_334389639_334389642_334389641", "52835765_334389642_30903525_334389642",
            "52835765_334389642_30903525_33958816");

    private final List<String> fixedRoute = Lists.newArrayList(
            "52955705_30994888_670715050_331876963", "52955705_30994888_670715050_5044761090", "52955705_670715050_2225831361_670715050",
            "52955705_670715050_2225831361_30994895", "52955705_670715050_2225831361_670715012", "52955705_2225831361_670714856_2225831361", "52955705_2225831361_670714856_670714987",
            "52955705_2225831361_670714856_30994897", "52955705_2225831361_670714856_670714981", "52955705_2225831361_670714856_5044761112", "52955705_2225831361_670714856_670714979",
            "52955705_2225831361_670714856_5044761113", "52955705_2225831361_670714856_670714973", "52955705_2225831361_670714856_670714911", "52955705_2225831361_670714856_30994898",
            "52955705_2225831361_670714856_670714909", "52955705_2225831361_670714856_30994899", "52955705_2225831361_670714856_670714883", "52955705_2225831361_670714856_670714862",
            "52924192_670714856_30994903_670714856", "52924192_670714856_30994903_5044761122", "52924192_670714856_30994903_30994901", "52924192_670714856_30994903_5044761120",
            "52924192_670714856_30994903_670714854", "52924192_670714856_30994903_670714850", "52924192_670714856_30994903_5044761117", "52924192_670714856_30994903_331877078",
            "52924192_670714856_30994903_5044761116", "52924192_670714856_30994903_670714830", "52924192_670714856_30994903_670714828", "52924192_670714856_30994903_5044846979",
            "52924192_670714856_30994903_30994902", "52924192_670714856_30994903_5044846981", "52924192_670714856_30994903_670714824", "52924187_30994903_670046017_30994903",
            "52924187_30994903_670046017_670714822", "52924187_30994903_670046017_670714817", "52924187_30994903_670046017_5044846983", "52924187_30994903_670046017_30994905",
            "52924187_30994903_670046017_670714712", "52924187_30994903_670046017_670714711", "52924187_30994903_670046017_5044846985", "52924187_30994903_670046017_670714695",
            "52924187_30994903_670046017_30994906", "52924187_30994903_670046017_670714637", "52924187_30994903_670046017_5044846986", "52924187_30994903_670046017_331877079",
            "52924187_30994903_670046017_5044846987", "52924187_30994903_670046017_670714635", "52924187_30994903_670046017_670714629", "52924187_30994903_670046017_30994907",
            "52924187_30994903_670046017_670714627", "52924187_30994903_670046017_5044846988", "52924187_30994903_670046017_331877080", "52924187_30994903_670046017_5044846990",
            "52924187_30994903_670046017_670714613", "52924187_30994903_670046017_5044846992", "52924187_30994903_670046017_5044847011", "52924187_30994903_670046017_30994908",
            "52924187_30994903_670046017_670714598", "52924187_30994903_670046017_670714596", "52924187_30994903_670046017_30994910", "52924187_30994903_670046017_5044847013",
            "52924187_30994903_670046017_670714588", "52924187_30994903_670046017_670714592", "52924187_30994903_670046017_30994911", "52924187_30994903_670046017_670714497",
            "52924187_30994903_670046017_670714491", "52924187_30994903_670046017_5044847015", "52924187_30994903_670046017_31021203", "52924187_30994903_670046017_5044847016",
            "52924187_30994903_670046017_31021204", "52924187_30994903_670046017_5044847020", "52924187_30994903_670046017_670714514", "52924187_30994903_670046017_670714503",
            "52924187_30994903_670046017_331877150", "52924187_30994903_670046017_670046050", "52924187_30994903_670046017_5044847223", "52924187_30994903_670046017_670046010",
            "52835767_670046017_334389638_670046017", "52835767_670046017_334389638_670046019", "52835767_670046017_334389638_670046014", "52835767_670046017_334389638_670046015",
            "52835767_670046017_334389638_670045998", "52835767_670046017_334389638_334389626", "52835767_670046017_334389638_670045999", "52835767_670046017_334389638_334389627",
            "52835767_670046017_334389638_670045997", "52835767_670046017_334389638_670045996", "52835767_670046017_334389638_334389628", "52835767_670046017_334389638_670045992",
            "52835767_670046017_334389638_334389629", "52835767_670046017_334389638_670045993", "52835767_670046017_334389638_334389630", "52835767_670046017_334389638_670045994",
            "52835767_670046017_334389638_334389631", "52835767_670046017_334389638_670045985", "52835767_670046017_334389638_334389632", "52835767_670046017_334389638_670045986",
            "52835767_670046017_334389638_334389633", "52835767_670046017_334389638_670045987", "52835767_670046017_334389638_334389634", "52835767_670046017_334389638_670045989",
            "52835767_670046017_334389638_334389635", "52835767_670046017_334389638_670045991", "52835767_670046017_334389638_334389636", "52835767_670046017_334389638_670046000",
            "52835767_670046017_334389638_334389637", "52835767_670046017_334389638_670046002", "48403983_334389638_334389639_334389638", "48403988_334389639_334389642_334389639",
            "48403988_334389639_334389642_334389640", "48403988_334389639_334389642_334389641", "52835765_334389642_30903525_334389642", "52835765_334389642_30903525_33958816");

    @Rule
    public TemporaryFolder folder = new TemporaryFolder();

    private Database database;

    @Before
    public void setUp() throws IOException {
        final File dbFileCopy = folder.newFile("Girona.db");

        FileUtils.copyInputStreamToFile(getClass().getResourceAsStream("/Girona.db"), dbFileCopy);

        database = Database.loadFromFile(dbFileCopy);
    }


    @Test
    public void GironaFix() {
        RouteFixer routeFixer = new RouteFixer(database, 8);

        List<String> fixedRoute = routeFixer.fixRoute(brokenRoute);

        assertTrue(fixedRoute.size() > brokenRoute.size());
        assertEquals(this.fixedRoute, fixedRoute);
    }

}